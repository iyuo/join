{"version":3,"file":"join.es.js","sources":["../src/join.ts"],"sourcesContent":["import { pluginize, IPlugin } from \"@iyuo/context\";\r\n\r\n/**\r\n * Join Types\r\n */\r\nexport enum JoinTypes {\r\n  none = 0b0000,\r\n  left = 0b1000,\r\n  right = 0b0001,\r\n  midLeft = 0b0100,\r\n  midRight = 0b0010,\r\n  midMerge = midLeft | midRight,\r\n  innerJoin = none | midMerge | none,\r\n  leftJoin = left | midMerge | none,\r\n  rightJoin = none | midMerge | right,\r\n  fullJoin = left | midMerge | right\r\n}\r\n\r\nfunction getPartNames(left: any, right: any) {\r\n  let namesLeft = Object.getOwnPropertyNames(left);\r\n  let namesRight = Object.getOwnPropertyNames(right);\r\n  let namesMid = namesLeft.filter(x => namesRight.indexOf(x) > -1);\r\n  namesLeft = namesLeft.filter(x => namesMid.indexOf(x) < 0);\r\n  namesRight = namesRight.filter(x => namesMid.indexOf(x) < 0);\r\n  return {\r\n    left: namesLeft,\r\n    middle: namesMid,\r\n    right: namesRight\r\n  };\r\n}\r\n\r\nfunction clearNames(obj: any, names: string[]) {\r\n  for (let i = 0; i < names.length; i++) {\r\n    delete obj[names[i]];\r\n  }\r\n}\r\n\r\nfunction attach(toObj: any, attachment: any, names: string[]) {\r\n  if (toObj === attachment) return;\r\n\r\n  for (let i = 0; i < names.length; i++) {\r\n    let descriptor = Object.getOwnPropertyDescriptor(attachment, names[i]);\r\n    Object.defineProperty(toObj, names[i], descriptor as PropertyDescriptor);\r\n  }\r\n}\r\n\r\nfunction isFunction(obj: any) {\r\n  // Support: Chrome <=57, Firefox <=52\r\n  // In some browsers, typeof returns \"function\" for HTML <object> elements\r\n  // (i.e., `typeof document.createElement( \"object\" ) === \"function\"`).\r\n  // We don't want to classify *any* DOM node as a function.\r\n  return typeof obj === \"function\" && typeof obj.nodeType !== \"number\";\r\n}\r\n\r\nfunction isPlainObject(obj: any) {\r\n  var proto, Ctor;\r\n  let toString = Object.prototype.toString;\r\n  let getProto = Object.getPrototypeOf;\r\n  let hasOwn = Object.prototype.hasOwnProperty;\r\n  var fnToString = hasOwn.toString;\r\n  var ObjectFunctionString = fnToString.call(Object);\r\n\r\n  // Detect obvious negatives\r\n  // Use toString instead of type to catch host objects\r\n  if (!obj || toString.call(obj) !== \"[object Object]\") {\r\n    return false;\r\n  }\r\n\r\n  proto = getProto(obj);\r\n\r\n  // Objects with no prototype (e.g., `Object.create( null )`) are plain\r\n  if (!proto) {\r\n    return true;\r\n  }\r\n\r\n  // Objects with prototype are plain iff they were constructed by a global Object function\r\n  Ctor = hasOwn.call(proto, \"constructor\") && proto.constructor;\r\n  return (\r\n    typeof Ctor === \"function\" && fnToString.call(Ctor) === ObjectFunctionString\r\n  );\r\n}\r\n\r\nfunction extend(...args: any[]) {\r\n  var options,\r\n    name,\r\n    src,\r\n    copy,\r\n    copyIsArray,\r\n    clone,\r\n    target = arguments[0] || {},\r\n    i = 1,\r\n    length = arguments.length,\r\n    deep = false;\r\n\r\n  // Handle a deep copy situation\r\n  if (typeof target === \"boolean\") {\r\n    deep = target;\r\n\r\n    // Skip the boolean and the target\r\n    target = arguments[i] || {};\r\n    i++;\r\n  }\r\n\r\n  // Handle case when target is a string or something (possible in deep copy)\r\n  if (typeof target !== \"object\" && !isFunction(target)) {\r\n    target = {};\r\n  }\r\n\r\n  // Extend itself if only one argument is passed\r\n  if (i === length) {\r\n    target = {};\r\n    i--;\r\n  }\r\n\r\n  for (; i < length; i++) {\r\n    // Only deal with non-null/undefined values\r\n    if ((options = arguments[i]) != null) {\r\n      // Extend the base object\r\n      for (name in options) {\r\n        copy = options[name];\r\n\r\n        // Prevent Object.prototype pollution\r\n        // Prevent never-ending loop\r\n        if (name === \"__proto__\" || target === copy) {\r\n          continue;\r\n        }\r\n\r\n        // Recurse if we're merging plain objects or arrays\r\n        if (\r\n          deep &&\r\n          copy &&\r\n          (isPlainObject(copy) || (copyIsArray = Array.isArray(copy)))\r\n        ) {\r\n          src = target[name];\r\n\r\n          // Ensure proper type for the source value\r\n          if (copyIsArray && !Array.isArray(src)) {\r\n            clone = [];\r\n          } else if (!copyIsArray && !isPlainObject(src)) {\r\n            clone = {};\r\n          } else {\r\n            clone = src;\r\n          }\r\n          copyIsArray = false;\r\n\r\n          // Never move original objects, clone them\r\n          target[name] = extend(deep, clone, copy);\r\n\r\n          // Don't bring in undefined values\r\n        } else if (copy !== undefined) {\r\n          target[name] = copy;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // Return the modified object\r\n  return target;\r\n}\r\n\r\nfunction mergeObjects(left: any, right: any, names: string[]) {\r\n  if (left === right) return;\r\n  for (let i = 0; i < names.length; i++) {\r\n    if (\r\n      right[names[i]] === null ||\r\n      [\r\n        \"string\",\r\n        \"boolean\",\r\n        \"null\",\r\n        \"undefined\",\r\n        \"symbol\",\r\n        \"number\",\r\n        \"bigint\",\r\n        \"regexp\"\r\n      ].indexOf((typeof right[names[i]]).toLowerCase()) > -1\r\n    ) {\r\n      let descriptor = Object.getOwnPropertyDescriptor(right, names[i]);\r\n      Object.defineProperty(left, names[i], descriptor as PropertyDescriptor);\r\n    } else {\r\n      left[names[i]] = extend(true, left[names[i]], right[names[i]]);\r\n    }\r\n  }\r\n}\r\n\r\nfunction joinSource<TContext, TJoinObject>(\r\n  this: TContext,\r\n  withObject: TJoinObject,\r\n  joinType: JoinTypes\r\n): TContext & TJoinObject {\r\n  if ((joinType | 0b1111) <= 0)\r\n    throw new Error(\"Invalid join type. Please select join type\");\r\n\r\n  if (joinType === (JoinTypes.left | JoinTypes.midLeft)) {\r\n    return this as any;\r\n  }\r\n\r\n  let names = getPartNames(this, withObject);\r\n\r\n  //merge\r\n  switch (joinType & JoinTypes.midMerge) {\r\n    case JoinTypes.none:\r\n      clearNames(this, names.middle);\r\n      break;\r\n    case JoinTypes.midLeft:\r\n      break;\r\n    case JoinTypes.midRight:\r\n      attach(this, withObject, names.middle);\r\n      break;\r\n    case JoinTypes.midMerge:\r\n      mergeObjects(this, withObject, names.middle);\r\n      break;\r\n  }\r\n\r\n  //left\r\n  if ((joinType & JoinTypes.left) !== JoinTypes.left) {\r\n    clearNames(this, names.left);\r\n  }\r\n\r\n  //right\r\n  if ((joinType & JoinTypes.right) === JoinTypes.right) {\r\n    attach(this, withObject, names.right);\r\n  }\r\n\r\n  return this as any;\r\n}\r\n\r\nexport function join<TContext, TJoinObject>(\r\n  joinType: JoinTypes,\r\n  withObject: TJoinObject\r\n): IPlugin<TContext, TContext & TJoinObject> {\r\n  return function(this: TContext) {\r\n    return joinSource.call(this, withObject, joinType);\r\n  } as any;\r\n}\r\n"],"names":[],"mappings":"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"}