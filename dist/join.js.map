{"version":3,"file":"join.js","sources":["../src/join.ts"],"sourcesContent":["import { pluginize, IPlugin } from \"@iyuo/context\";\r\n\r\n/**\r\n * Join Types\r\n */\r\nexport enum JoinTypes {\r\n  none = 0b0000,\r\n  left = 0b1000,\r\n  right = 0b0001,\r\n  midLeft = 0b0100,\r\n  midRight = 0b0010,\r\n  midMerge = midLeft | midRight,\r\n  innerJoin = none | midMerge | none,\r\n  leftJoin = left | midMerge | none,\r\n  rightJoin = none | midMerge | right,\r\n  fullJoin = left | midMerge | right\r\n}\r\n\r\nfunction getPartNames(left: any, right: any) {\r\n  let namesLeft = Object.getOwnPropertyNames(left);\r\n  let namesRight = Object.getOwnPropertyNames(right);\r\n  let namesMid = namesLeft.filter(x => namesRight.indexOf(x) > -1);\r\n  namesLeft = namesLeft.filter(x => namesMid.indexOf(x) < 0);\r\n  namesRight = namesRight.filter(x => namesMid.indexOf(x) < 0);\r\n  return {\r\n    left: namesLeft,\r\n    middle: namesMid,\r\n    right: namesRight\r\n  };\r\n}\r\n\r\nfunction clearNames(obj: any, names: string[]) {\r\n  for (let i = 0; i < names.length; i++) {\r\n    delete obj[names[i]];\r\n  }\r\n}\r\n\r\nfunction attach(toObj: any, attachment: any, names: string[]) {\r\n  if (toObj === attachment) return;\r\n\r\n  for (let i = 0; i < names.length; i++) {\r\n    let descriptor = Object.getOwnPropertyDescriptor(attachment, names[i]);\r\n    Object.defineProperty(toObj, names[i], descriptor as PropertyDescriptor);\r\n  }\r\n}\r\n\r\nfunction isFunction(obj: any) {\r\n  // Support: Chrome <=57, Firefox <=52\r\n  // In some browsers, typeof returns \"function\" for HTML <object> elements\r\n  // (i.e., `typeof document.createElement( \"object\" ) === \"function\"`).\r\n  // We don't want to classify *any* DOM node as a function.\r\n  return typeof obj === \"function\" && typeof obj.nodeType !== \"number\";\r\n}\r\n\r\nfunction isPlainObject(obj: any) {\r\n  var proto, Ctor;\r\n  let toString = Object.prototype.toString;\r\n  let getProto = Object.getPrototypeOf;\r\n  let hasOwn = Object.prototype.hasOwnProperty;\r\n  var fnToString = hasOwn.toString;\r\n  var ObjectFunctionString = fnToString.call(Object);\r\n\r\n  // Detect obvious negatives\r\n  // Use toString instead of type to catch host objects\r\n  if (!obj || toString.call(obj) !== \"[object Object]\") {\r\n    return false;\r\n  }\r\n\r\n  proto = getProto(obj);\r\n\r\n  // Objects with no prototype (e.g., `Object.create( null )`) are plain\r\n  if (!proto) {\r\n    return true;\r\n  }\r\n\r\n  // Objects with prototype are plain iff they were constructed by a global Object function\r\n  Ctor = hasOwn.call(proto, \"constructor\") && proto.constructor;\r\n  return (\r\n    typeof Ctor === \"function\" && fnToString.call(Ctor) === ObjectFunctionString\r\n  );\r\n}\r\n\r\nfunction extend(...args: any[]) {\r\n  var options,\r\n    name,\r\n    src,\r\n    copy,\r\n    copyIsArray,\r\n    clone,\r\n    target = arguments[0] || {},\r\n    i = 1,\r\n    length = arguments.length,\r\n    deep = false;\r\n\r\n  // Handle a deep copy situation\r\n  if (typeof target === \"boolean\") {\r\n    deep = target;\r\n\r\n    // Skip the boolean and the target\r\n    target = arguments[i] || {};\r\n    i++;\r\n  }\r\n\r\n  // Handle case when target is a string or something (possible in deep copy)\r\n  if (typeof target !== \"object\" && !isFunction(target)) {\r\n    target = {};\r\n  }\r\n\r\n  // Extend itself if only one argument is passed\r\n  if (i === length) {\r\n    target = {};\r\n    i--;\r\n  }\r\n\r\n  for (; i < length; i++) {\r\n    // Only deal with non-null/undefined values\r\n    if ((options = arguments[i]) != null) {\r\n      // Extend the base object\r\n      for (name in options) {\r\n        copy = options[name];\r\n\r\n        // Prevent Object.prototype pollution\r\n        // Prevent never-ending loop\r\n        if (name === \"__proto__\" || target === copy) {\r\n          continue;\r\n        }\r\n\r\n        // Recurse if we're merging plain objects or arrays\r\n        if (\r\n          deep &&\r\n          copy &&\r\n          (isPlainObject(copy) || (copyIsArray = Array.isArray(copy)))\r\n        ) {\r\n          src = target[name];\r\n\r\n          // Ensure proper type for the source value\r\n          if (copyIsArray && !Array.isArray(src)) {\r\n            clone = [];\r\n          } else if (!copyIsArray && !isPlainObject(src)) {\r\n            clone = {};\r\n          } else {\r\n            clone = src;\r\n          }\r\n          copyIsArray = false;\r\n\r\n          // Never move original objects, clone them\r\n          target[name] = extend(deep, clone, copy);\r\n\r\n          // Don't bring in undefined values\r\n        } else if (copy !== undefined) {\r\n          target[name] = copy;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // Return the modified object\r\n  return target;\r\n}\r\n\r\nfunction mergeObjects(left: any, right: any, names: string[]) {\r\n  if (left === right) return;\r\n  for (let i = 0; i < names.length; i++) {\r\n    if (\r\n      right[names[i]] === null ||\r\n      [\r\n        \"string\",\r\n        \"boolean\",\r\n        \"null\",\r\n        \"undefined\",\r\n        \"symbol\",\r\n        \"number\",\r\n        \"bigint\",\r\n        \"regexp\"\r\n      ].indexOf((typeof right[names[i]]).toLowerCase()) > -1\r\n    ) {\r\n      let descriptor = Object.getOwnPropertyDescriptor(right, names[i]);\r\n      Object.defineProperty(left, names[i], descriptor as PropertyDescriptor);\r\n    } else {\r\n      left[names[i]] = extend(true, left[names[i]], right[names[i]]);\r\n    }\r\n  }\r\n}\r\n\r\nfunction joinSource<TContext, TJoinObject>(\r\n  this: TContext,\r\n  withObject: TJoinObject,\r\n  joinType: JoinTypes\r\n): TContext & TJoinObject {\r\n  if ((joinType | 0b1111) <= 0)\r\n    throw new Error(\"Invalid join type. Please select join type\");\r\n\r\n  if (joinType === (JoinTypes.left | JoinTypes.midLeft)) {\r\n    return this as any;\r\n  }\r\n\r\n  let names = getPartNames(this, withObject);\r\n\r\n  //merge\r\n  switch (joinType & JoinTypes.midMerge) {\r\n    case JoinTypes.none:\r\n      clearNames(this, names.middle);\r\n      break;\r\n    case JoinTypes.midLeft:\r\n      break;\r\n    case JoinTypes.midRight:\r\n      attach(this, withObject, names.middle);\r\n      break;\r\n    case JoinTypes.midMerge:\r\n      mergeObjects(this, withObject, names.middle);\r\n      break;\r\n  }\r\n\r\n  //left\r\n  if ((joinType & JoinTypes.left) !== JoinTypes.left) {\r\n    clearNames(this, names.left);\r\n  }\r\n\r\n  //right\r\n  if ((joinType & JoinTypes.right) === JoinTypes.right) {\r\n    attach(this, withObject, names.right);\r\n  }\r\n\r\n  return this as any;\r\n}\r\n\r\nexport function join<TContext, TJoinObject>(\r\n  joinType: JoinTypes,\r\n  withObject: TJoinObject\r\n): IPlugin<TContext, TContext & TJoinObject> {\r\n  return function(this: TContext) {\r\n    return joinSource.call(this, withObject, joinType);\r\n  } as any;\r\n}\r\n"],"names":["JoinTypes"],"mappings":"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"}